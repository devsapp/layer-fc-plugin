var w=(o,n)=>()=>(n||o((n={exports:{}}).exports,n),n.exports);var $=w((Y,T)=>{var d=require("@serverless-devs/core"),{lodash:r}=d,N={PATH:":/usr/local/bin/apache-maven/bin:/usr/local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/local/ruby/bin",LAYERS:{nodejs17:{layer:"node-v17.8.0-linux-x64",path:"/opt/node-v17.8.0-linux-x64/bin"},nodejs16:{layer:"node-v16.14.2-linux-x64",path:"/opt/node-v16.14.2-linux-x64/bin"},nodejs14:{layer:"node-v14.19.1-linux-x64",path:"/opt/node-v14.19.1-linux-x64/bin"},nodejs12:{layer:"node-v12.22.11-linux-x64",path:"/opt/node-v12.22.11-linux-x64/bin"},"python3.10":{layer:"python-v3.10-linux-x64",path:"/opt/python-v3.10-linux-x64/bin"},"python3.9":{layer:"python-v3.9-linux-x64",path:"/opt/python-v3.9-linux-x64/bin"},"python3.8":{layer:"python-v3.8-linux-x64",path:"/opt/python-v3.8-linux-x64/bin"},"python3.6":{layer:"python-v3.6-linux-x64",path:"/opt/python-v3.6-linux-x64/bin"},"php8.1":{layer:"php-v8.1-linux-x64",path:"/opt/php-v8.1-linux-x64/bin"},"php8.0":{layer:"php-v8.0-linux-x64",path:"/opt/php-v8.0-linux-x64/bin"},"php7.2":{layer:"php-v7.2-linux-x64",path:"/opt/php-v7.2-linux-x64/bin"},"php5.6":{layer:"php-v5.6-linux-x64",path:"/opt/php-v5.6-linux-x64/bin"},java17:{layer:"java-v17.0.2-linux-x64",path:"/opt/java-v17.0.2-linux-x64/bin"},java11:{layer:"java-v11.0.14-linux-x64",path:"/opt/java-v11.0.14-linux-x64/bin"},typescript:{layer:"node-v16.14.2-linux-x64",path:"/opt/node-v16.14.2-linux-x64/bin"},dotnet6:{layer:"dotnet6",path:"/opt/dotnet6"}}},S=(o,n)=>{if(!n)throw new d.CatchableError("layer-fc args must exist!");if(n.name){if(!(n.codeUri||n.ossBucket))throw new d.CatchableError("Missing args: codeUri or ossBucket");r.isEmpty(n.runtime)||r.includes(n.runtime,r.get(o,"props.function.runtime"))||(n.runtime=r.concat(n.runtime,r.get(o,"props.function.runtime")))}else if(n.customRuntime&&r.get(o,"props.function.runtime")!=="custom")throw new d.CatchableError(`props.function.runtime: "${r.get(o,"props.function.runtime")}" is not correct, Should be "custom"`)};T.exports={SYSTERMPATH:N,checkArgs:S}});var U=require("@serverless-devs/core"),{lodash:e,loadComponent:k,Logger:C}=U,j=new C("layer-fc"),{SYSTERMPATH:O,checkArgs:D}=$(),{PATH:F,LAYERS:E}=O;module.exports=async function(n,p){D(n,p),j.debug(`inputs params: ${JSON.stringify(n)}`),j.debug(`args params: ${JSON.stringify(p)}`);let{codeUri:H=null,description:R=null,customRuntime:u=null}=p,{ossBucket:v=null,ossKey:f=null,name:c=null,runtime:b}=p,_=e.get(n,"props.region","cn-hangzhou"),x={},g={};if(u)if(E[u])x=E[u],v=`fc-layers-${_}`,f=`${e.get(x,"layer")}.zip`,c=`${u}_fc_auto_created`,g={runtime:"custom"},b=["custom"];else return n;let i=e.merge(n,{props:{layerName:c,code:H,compatibleRuntime:b,description:R,ossBucket:v,ossKey:f,function:g}}),a=e.get(n,"props.function.environmentVariables",{NODE_PATH:void 0,PATH:void 0});if(e.isEmpty(x)){let t=a.NODE_PATH,l="/opt/node_modules:/opt/nodejs/node_modules";e.includes(t,l)||(a.NODE_PATH=t?`${l}:${t}`:l)}else{let t=a.PATH||"",l=`${x.path}${F}`;e.includes(t,l)||(a.PATH=t?`${l}:${t}`:l)}let A=await k("devsapp/fc-layer"),h,m=await A.list({args:`--region ${n.props.region} --prefix ${c}`,credentials:n.credentials,project:n.project});p.forceUpdate||e.isEmpty(m)||e.size(e.filter(m,t=>t.layerName===c))===0?h=await A.publish(i):h=e.get(m,"[0].arn");let y=e.get(i,"props.layersFcInputsUni"),s=e.get(i,"props.function.layers",[]);e.isNil(y)&&(i.props.layersFcInputsUni=s,y=s);let P=e.dropRight(s,y.length);return h&&(P.push(h),s=e.concat(P,y)),i=e.merge(i,{props:{function:{environmentVariables:a,layers:s}}}),i};
